# 잡다구리 정보
## 00. 기본 설치
* pwntools 설치
  * 아직 python 3.x 버전을 지원하지 못함
  * https://github.com/Gallopsled/pwntools
```
sudo apt-get install python2.7 python2.7-dev python-pip
sudo pip install pwntools
sudo apt-get install libcapstone-dev
```
* gdb-peda 설치
  * https://github.com/longld/peda
```
git clone https://github.com/longld/peda.git ~/peda
echo "source ~/peda/peda.py" >> ~/.gdbinit
echo "DONE! debug your program with gdb and enjoy"
```
* check.sh 설치
  * 파일에 걸려있는 보호기법 확인
```
http://www.trapkit.de/tools/checksec.html
```


## 보호옵션 끄기
* ASLR 끄기
```
echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
```
* gcc랑 관련없는 건데 이 운영체제에서 계속 ASLR을 끄고 싶어
```
echo "kernel.randomize_va_space=0" > /etc/sysctl.d/01-disable-aslr.conf
```
* 32비트로 컴파일하고 싶어
```
-m32
```
* -m32 옵션을 줬는데 이상해
```
sudo apt install gcc-multilib
```

* 32비트로 컴파일하니까 main 함수에 스택을 정렬하는 이상한 인스트럭션이 있어서 짜증나
```
-mpreferred-stack-boundary=2
```

* 최적화 옵션을 주니까 printf@plt가 __printf_chk@plt로 바뀌는 게 싫어

```
-U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=0
```

* CANARY를 없애고 싶어
```
-fno-stack-protector
```
* 스택에 실행 권한을 주고 싶어
```
-z execstack
```
*No RELRO가 기본값인데 Partial RELRO가 필요해
```
-z relro
```
* No RELRO가 기본값인데 Full RELRO가 필요해
```
-z relro -z now
```
* Partial RELRO가 기본값인데 No RELRO가 필요해
```
-z norelro
```
* Partial RELRO가 기본값인데 Full RELRO가 필요해
```
-z now
```
* .text가 랜덤이면 좋겠어
```
-fpie
```
* PIE가 쓰고 싶어
```
-fpie -pie
```

* 스택에 실행권한 주기(NX bit/DEP)
  * gcc의 옵션중 -z execstack
  * 다시 nx를 활성화하여 실행하려면
```bash
$ execstack -c binary
```
* 스택 카나리 끄기
  * -fno-stack-protector
* PIE 옵션 끄기
  * PIE(Position Independent Executable)
  * 일반 실행파일과는 다르게 매우 작은 주소에 코드들이 위치. 동적 링커는 PIE를 실행할 때 PIC 공유 라이브러리에 대해 수행할 때와 마찬가지로 상대주소를 주소공간상에 매핑하여 실행
  * -w -no-pie

##  패턴만들기

* metasploit 이용

  ```bash
  $/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 100
  Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A
  ```

* gdb-peda 이용

  ```bash
  gdb-peda$ pattern create 100
  'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'
  ```


## gdb

* 함수 정보 찾기

  ```bash
  gdb-peda$ info function
  All defined functions:

  Non-debugging symbols:
  0x08049000  _init
  0x08049030  read@plt
  0x08049040  printf@plt
  0x08049050  __libc_start_main@plt
  0x08049060  dlsym@plt
  0x08049070  _start
  0x080490b0  _dl_relocate_static_pie
  0x080490c0  __x86.get_pc_thunk.bx
  0x080490d0  deregister_tm_clones
  ...
  ```


## objdump

* 함수 정보 찾기

  ```bash
  $objdump -d 프로그램명
  ```


## 값 입력

* 인자로 입력

  ```bash
  $python -c "print '값값값'" | ./프로그램
  ```

* gets 등 프로그램에서 입력



## 함수 주소 찾기/libc 이용

* 함수 주소는 ASLR이 적용되어 있다면 계속 변화하지만, 이것은 libcbase 주소가 변화하는 것이지 함수의 오프셋이 변화하지 않음
* 오프셋을 이용해야 reliable하게 가능: 함수주소 = libc base + 오프셋
* 현재 함수의 주소 - 현재 libc base = 릭된 함수의 주소 - [libc base]를 통해 계산 가능
* 즉 특정 함수의 주소를 릭해야함
* libc base = 현재 libc base - 현재 함수 주소 + 릭된 함수 주소
* https://github.com/niklasb/libc-database 에서 버전별 libc 주소 확인 가능
* libc 위치찾기

```
root@attacker:~/Study/LinuxExTech/# locate libc.so
/usr/lib/x86_64-linux-gnu/libc.so
/usr/lib/x86_64-linux-gnu/libc.so.6
/usr/lib32/libc.so.6
```



* 현재 libc base 주소 확인(gdb-peda)

  ```bash
  gdb-peda$ info proc map
  process 19033
  Mapped address spaces:

  	Start Addr   End Addr       Size     Offset objfile
  	 0x8048000  0x8049000     0x1000        0x0 /root/Study/LinuxExTech/02.ReturnToLibc/rtl2_32
  	 0x8049000  0x804a000     0x1000     0x1000 /root/Study/LinuxExTech/02.ReturnToLibc/rtl2_32
  	 0x804a000  0x804b000     0x1000     0x2000 /root/Study/LinuxExTech/02.ReturnToLibc/rtl2_32
  	 0x804b000  0x804c000     0x1000     0x2000 /root/Study/LinuxExTech/02.ReturnToLibc/rtl2_32
  	 0x804c000  0x804d000     0x1000     0x3000 /root/Study/LinuxExTech/02.ReturnToLibc/rtl2_32
  	0xf7dc5000 0xf7dde000    0x19000        0x0 /usr/lib32/libc-2.28.so
  	0xf7dde000 0xf7f2c000   0x14e000    0x19000 /usr/lib32/libc-2.28.so
  	0xf7f2c000 0xf7f9c000    0x70000   0x167000 /usr/lib32/libc-2.28.so
  	0xf7f9c000 0xf7f9d000     0x1000   0x1d7000
  ```

* 함수 주소 확인

  ```
  gdb-peda$ print system
  $6 = {<text variable, no debug info>} 0xf7e03980 <system>
  gdb-peda$ print printf
  $7 = {<text variable, no debug info>} 0xf7e178c0 <printf>
  ```

* 오프셋 계산

  ```
  gdb-peda$ p/x 0xf7e178c0(릭된 printf주소) - 0xf7dc5000(현재 libcbase)
  $8 = 0x528c0
  ```
