# Stack 이해

*

## 개략적인 구조

```
---------------------(높은주소)
Kernel 영역
---------------------
스택영역(지역변수) : 아래로 자람
---------------------
힙영역(동적할당)
---------------------
데이터영역
---------------------
코드영역
----------------------(낮은주소)
```



## 스택이해

* 스택의 사용과 CPU의 명령을 따로 생각할 필요가 있음
* CPU 명령은 코드 영역에서 한줄한줄 명령을 실행하고, 이때 필요한 데이터들을 스택에서 넣고 빼면서 사용하는 것임



### 1) 스택 프레임의 생성(함수 프롤로그)과 반환(에필로그)

* 결과적으로 가장 중요한 스택 프레임의 구조는 아래와 같음

```
    |---------------|
  +8|      n        |
    |---------------|
  +4|  Return Adrs  |
    |---------------|
   0| // old ebp // | <--- $ebp
    |---------------|
  -4|           	|
    |---------------|
  -8|               |
    |---------------|
 -12|               | <--- $esp
    |---------------|
```



* stack은 높은 주소에서 낮은 주소로 자람
* 관련 주요 레지스터
  * rbp(ebp): 스택의 베이스
  * rsp(esp): 스택의 최상단(아래로 자라므로 가장 낮은 주소가 됨)
  * eip(eip)
* 아래의 프로그램을 통해 함수가 호출될 때의 스택의 변화를 단계적으로 살펴보자.

```c
//stack.c
#include <stdio.h>

int sum(int a, int b){
    return a+b;
}
int main(){
    sum(1,2);
}

```

```bash
gdb-peda$ disass main
Dump of assembler code for function main:
   0x08049169 <+0>:     push   ebp
   0x0804916a <+1>:     mov    ebp,esp
   0x0804916c <+3>:     call   0x8049189 <__x86.get_pc_thunk.ax>
   0x08049171 <+8>:     add    eax,0x2e8f
   0x08049176 <+13>:    push   0x2
   0x08049178 <+15>:    push   0x1
   0x0804917a <+17>:    call   0x8049152 <sum>
   0x0804917f <+22>:    add    esp,0x8
   0x08049182 <+25>:    mov    eax,0x0
   0x08049187 <+30>:    leave
   0x08049188 <+31>:    ret
End of assembler dump.
gdb-peda$ disass sum
Dump of assembler code for function sum:
   0x08049152 <+0>:     push   ebp
   0x08049153 <+1>:     mov    ebp,esp
   0x08049155 <+3>:     call   0x8049189 <__x86.get_pc_thunk.ax>
   0x0804915a <+8>:     add    eax,0x2ea6
   0x0804915f <+13>:    mov    edx,DWORD PTR [ebp+0x8]
   0x08049162 <+16>:    mov    eax,DWORD PTR [ebp+0xc]
   0x08049165 <+19>:    add    eax,edx
   0x08049167 <+21>:    pop    ebp
   0x08049168 <+22>:    ret
End of assembler dump.
gdb-peda$
```

* 아래와 같이 breakpoint를 잡아 각 부분별 스택 상황을 살펴봄
  * main+0: push ebp 전
  * main+1: push ebp후,  mov ebp, esp 전
  * main+3: mov ebp, esp 후
  * main+17: call sum 전
  * sum+0: call sum 후, push ebp 전
  * sum+1: push ebp후, mov ebp, esp 전
  * sum+3: mov ebp, esp 후
  * sum+22: ret 전
  * main+22: sum ret 후

```
gdb-peda$ b *main+0
Breakpoint 1 at 0x8049169
gdb-peda$ b *main+1
Breakpoint 2 at 0x804916a
gdb-peda$ b *main+3
Breakpoint 3 at 0x804916c
gdb-peda$ b *main+17
Breakpoint 4 at 0x804917a
gdb-peda$ b *sum+0
Breakpoint 5 at 0x8049152
gdb-peda$ b *sum+1
Breakpoint 6 at 0x8049153
gdb-peda$ b *sum+3
Breakpoint 7 at 0x8049155
gdb-peda$ b *sum+22
Breakpoint 8 at 0x8049168
gdb-peda$ b *main+22
Breakpoint 9 at 0x804917f
gdb-peda$ r

```

* main+0: push ebp 전

```
[Stack]
0000| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0004| 0xffffd600 --> 0x1
...
[register]
EBP: 0x0
ESP: 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:        add    esp,0x10)

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		esp:0xffffd5fc
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

* main+1: push ebp 후

```
[Stack]
0000| 0xffffd5f8 --> 0x0
0004| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0008| 0xffffd600 --> 0x1
...
[register]
EBP: 0x0
ESP: 0xffffd5f8 --> 0x0

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  esp:0xffffd5f8
-------------------------

```

* main+3: mov ebp, esp 후
  * 여기서 새로운 스택 프레임(main)이 만들어짐

```
[Stack]
0000| 0xffffd5f8 --> 0x0
0004| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0008| 0xffffd600 --> 0x1
...
[register]
EBP: 0xffffd5f8 --> 0x0 <-- 변경됨
ESP: 0xffffd5f8 --> 0x0

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  esp:0xffffd5f8
-------------------------

```

* main+17
  * sum 함수의 인자가 오른쪽부터 삽입됨

```
[Stack]
0000| 0xffffd5f0 --> 0x1
0004| 0xffffd5f4 --> 0x2
0008| 0xffffd5f8 --> 0x0
0012| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0016| 0xffffd600 --> 0x1

...
[register]
EBP: 0xffffd5f8 --> 0x0
ESP: 0xffffd5f0 --> 0x1

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		    esp:0xffffd5f0
-------------------------
```

* sum+0: sum 함수의 push ebp 전

```
[Stack]
0000| 0xffffd5ec --> 0x804917f (<main+22>:      add    esp,0x8)
0004| 0xffffd5f0 --> 0x1
0008| 0xffffd5f4 --> 0x2
0012| 0xffffd5f8 --> 0x0
0016| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0020| 0xffffd600 --> 0x1
...
[register]
EBP: 0xffffd5f8 --> 0x0
ESP: 0xffffd5ec --> 0x804917f (<main+22>:       add    esp,0x8)

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		   
-------------------------
0x804917f(sum이후 리턴할 곳)	esp:0xffffd5ec
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

* sum+1: push ebp 후

```
[Stack]
0000| 0xffffd5e8 --> 0xffffd5f8 --> 0x0
0004| 0xffffd5ec --> 0x804917f (<main+22>:      add    esp,0x8)
0008| 0xffffd5f0 --> 0x1
0012| 0xffffd5f4 --> 0x2
0016| 0xffffd5f8 --> 0x0
0020| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0024| 0xffffd600 --> 0x1
...
[register]
EBP: 0xffffd5f8 --> 0x0
ESP: 0xffffd5e8 --> 0xffffd5f8 --> 0x0

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		   
-------------------------
0x804917f(sum이후 리턴할 곳)
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0xffffd5f8(main의 ebp)	  esp: 0xffffd5e8
-------------------------
```

* sum+3: mov ebp, esp 후
  * sum의 스택프레임이 새로 생성됨

```
[Stack]
0000| 0xffffd5e8 --> 0xffffd5f8 --> 0x0
0004| 0xffffd5ec --> 0x804917f (<main+22>:      add    esp,0x8)
0008| 0xffffd5f0 --> 0x1
0012| 0xffffd5f4 --> 0x2
0016| 0xffffd5f8 --> 0x0
0020| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0024| 0xffffd600 --> 0x1
...
[register]
EBP: 0xffffd5e8 --> 0xffffd5f8 --> 0x0  <-- 변경됨
ESP: 0xffffd5e8 --> 0xffffd5f8 --> 0x0


[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		   
-------------------------
0x804917f(sum이후 리턴할 곳)
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0xffffd5f8(main의 ebp)	  esp: 0xffffd5e8
-------------------------
```

* sum+22: ret 전
  * sum+21에서 pop ebp를 통해 스택의 값을 ebp로 넣음
  * esp가 가리키는 값에 ret 주소가 들어있음

```
[Stack]
0000| 0xffffd5ec --> 0x804917f (<main+22>:      add    esp,0x8)
0004| 0xffffd5f0 --> 0x1
0008| 0xffffd5f4 --> 0x2
0012| 0xffffd5f8 --> 0x0
0016| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0020| 0xffffd600 --> 0x1

[register]
EBP: 0xffffd5f8 --> 0x0   <-- 메인의 스택프레임 주소로 변경
ESP: 0xffffd5ec --> 0x804917f (<main+22>:       add    esp,0x8)

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		   
-------------------------
0x804917f(sum이후 리턴할 곳)	esp: 0xffffd5ec
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

* main+22: sum 함수 종료

```
[Stack]
0000| 0xffffd5f0 --> 0x1
0004| 0xffffd5f4 --> 0x2
0008| 0xffffd5f8 --> 0x0
0012| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0016| 0xffffd600 --> 0x1

[register]
EBP: 0xffffd5f8 --> 0x0
ESP: 0xffffd5f0 --> 0x1

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		  esp: 0xffffd5f0
-------------------------
```

* main+25
  * add esp, 0x8 ; esp에 0x8을 더하므로 esp가 상단으로 올라감

```
[Stack]
0000| 0xffffd5f8 --> 0x0
0004| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0008| 0xffffd600 --> 0x1


[register]
EBP: 0xffffd5f8 --> 0x0
ESP: 0xffffd5f8 --> 0x0

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						 esp: 0xffffd5f8
-------------------------
```



### 2) Stack Aligment

### (1) 함수 프롤로그

* main함수를 디스어셈블 했을 때 함수 프롤로그 앞에 아래와 같은 부분이 존재함
  * SSE(Streaming SIMD Extension) 데이터 타입을 위한 stack realign
  * 컴파일시 -mpreferred-stack-boundary=2(4바이트 정렬)로 없앨 수 있음

```
   0x0804920f <+0>:	lea    ecx,[esp+0x4]
   0x08049213 <+4>:	and    esp,0xfffffff0
   0x08049216 <+7>:	push   DWORD PTR [ecx-0x4]
```





```
=> 0x804920f <main>:	lea    ecx,[esp+0x4]

ECX: 0x3f8d67f3
ESP: 0xffffd5cc

			|-----------------------|
0xffffd5c0	|    0x2        		|
      	  	|-----------------------|
0xffffd5bc	| 	Ret(0xf7ddfb41)		| <---$esp
			|-----------------------|
```

* main+0:	lea    ecx,[esp+0x4]
  * esp+4의 주소를 ecx 레지스터에 넣음
  * main 함수가 호출되었을 때 ret를 스택에 push했을 것이고 esp는 ret를 가리키고 있음
    * ret: __libc_start_main() 함수로 돌아감
  * 이 부분의 역할은 esp를 16바이트 단위로 정렬하기 위함(성능 향상 위함)
  * and를 실행하는 과정에서 esp가 변경될 수 있음로 리턴 주소 저장

```
   0x804920f <main>:	lea    ecx,[esp+0x4]
=> 0x8049213 <main+4>:	and    esp,0xfffffff0

ECX: xffffd5c0
ESP: 0xffffd5bc

			|-----------------------|
0xffffd5c0	|    0x2        		| <---$ecx에 담긴 값이 가리키는 주소
      	  	|-----------------------|
0xffffd5bc	| 	Ret(0xf7ddfb41)		| <---$esp
			|-----------------------|
```

- main+4: and    esp,0xfffffff0
  - esp 위치를 and 연산을 통해 변경(16바이트 정렬)
  - 정수 N의 16배수는 왼쪽으로 네번 쉬프트되는 것으로, 하위 4비트 0임
  - 결과적으로 esp는 이전과 동일하거나 작은 값(스택이 자라남)

```
   0x804920f <main>:	lea    ecx,[esp+0x4]
   0x8049213 <main+4>:	and    esp,0xfffffff0
=> 0x8049216 <main+7>:	push   DWORD PTR [ecx-0x4]

ECX: 0xffffd5c0
ESP: 0xffffd5b0

			|-----------------------|
0xffffd5c0	|    0x2        		| <---$ecx에 담긴 값이 가리키는 주소
      	  	|-----------------------|
0xffffd5bc	| 	Ret(0xf7ddfb41)		|
			|-----------------------|
0xffffd5b8	|     	0x0        		|
      	  	|-----------------------|
0xffffd5b4	|     0xf7f9f000   		|
      	  	|-----------------------|
0xffffd5b0	|     0xf7f9f000     	|<---$esp
      	  	|-----------------------|

```





* main+7:  push   DWORD PTR [ecx-0x4]
  * ecx레지스터에서 4를 뺀 값(ret)을 현재 스택에 저장

```
   0x804920f <main>:	lea    ecx,[esp+0x4]
   0x8049213 <main+4>:	and    esp,0xfffffff0
   0x8049216 <main+7>:	push   DWORD PTR [ecx-0x4]
=> 0x8049219 <main+10>:	push   ebp

ECX: 0xffffd5c0
ESP: 0xffffd5ac

			|-----------------------|
0xffffd5c0	|    0x2        		| <---$ecx에 담긴 값이 가리키는 주소
      	  	|-----------------------|
0xffffd5bc	| 	Ret(0xf7ddfb41)		|
			|-----------------------|
0xffffd5b8	|     	0x0        		|
      	  	|-----------------------|
0xffffd5b4	|     0xf7f9f000   		|
      	  	|-----------------------|
0xffffd5b0	|     0xf7f9f000     	|
      	  	|-----------------------|
0xffffd5ac	|   Ret(0xf7ddfb41)    	|<---$esp: 이 부분이 실제 ret가 됨
      	  	|-----------------------|

```

* main+13:
  * 함수 프롤로그에서 push ebp, mov ebp, esp를 통해 현재 esp가 ebp레지스터에 저장

```
   0x804920f <main>:	lea    ecx,[esp+0x4]
   0x8049213 <main+4>:	and    esp,0xfffffff0   
   0x8049216 <main+7>:	push   DWORD PTR [ecx-0x4]
   0x8049219 <main+10>:	push   ebp
   0x804921a <main+11>:	mov    ebp,esp
=> 0x804921c <main+13>:	push   ebx

ECX: 0xffffd5c0
ESP: 0xffffd5a8
EBP: 0xffffd5a8


			|-----------------------|
0xffffd5c0	|    0x2        		| <---$ecx에 담긴 값이 가리키는 주소
      	  	|-----------------------|
0xffffd5bc	| 	Ret(0xf7ddfb41)		|
			|-----------------------|
0xffffd5b8	|     	0x0        		|
      	  	|-----------------------|
0xffffd5b4	|     0xf7f9f000   		|
      	  	|-----------------------|
0xffffd5b0	|     0xf7f9f000     	|
      	  	|-----------------------|
0xffffd5ac	|   Ret(0xf7ddfb41)    	|
      	  	|-----------------------|
0xffffd5b8	|     	0x0		    	|<---$esp
      	  	|-----------------------|

```



###

### (2) 함수 에필로그

- main함수를 디스어셈블 했을 때 함수 에필로그 부분에 아래와 같은 부분이 존재함
  - leave / ret 가 아님
    - mov esp, ebp / pop ebp / ret

```
=> 0x8049252 <main+67>:	lea    esp,[ebp-0x8]
   0x8049255 <main+70>:	pop    ecx
   0x8049256 <main+71>:	pop    ebx
   0x8049257 <main+72>:	pop    ebp
   0x8049258 <main+73>:	lea    esp,[ecx-0x4]

ECX: 0xffffd56c
ESP: 0xffffd5a0
EBP: 0xffffd5a8   

			|-----------------------|
0xffffd5c0	|    0x2        		| <---$ecx에 담긴 값이 가리키는 주소
      	  	|-----------------------|
0xffffd5bc	| 	Ret(0xf7ddfb41)		|
			|-----------------------|
0xffffd5b8	|     	0x0        		|
      	  	|-----------------------|
0xffffd5b4	|     0xf7f9f000   		|
      	  	|-----------------------|
0xffffd5b0	|     0xf7f9f000     	|
      	  	|-----------------------|
0xffffd5ac	|   Ret(0xf7ddfb41)    	|
      	  	|-----------------------|
0xffffd5b8	|     	0x0		    	|
      	  	|-----------------------|
0xffffd5b4	|     0xf7f9f000		|
      	  	|-----------------------|
0xffffd5b0	|     0xf7f9f000		|
      	  	|-----------------------|
0xffffd5ac	|     0xf7ddfb41		|
      	  	|-----------------------|
0xffffd5a8	|     	0x0		    	| <-- $ebp에 담긴 값이 가리키는 주소
      	  	|-----------------------|
0xffffd5a4	|     	0x0		    	|
      	  	|-----------------------|
0xffffd5a0	|     0xffffd5c0		| <---$esp
      	  	|-----------------------|

```

* main+67: lea    esp,[ebp-0x8]
  * ebp-0x8의 위치로 esp를 옮김
* 0x8049255 <main+70>:	pop    ecx
  0x8049256 <main+71>:	pop    ebx
  0x8049257 <main+72>:	pop    ebp
  0x8049258 <main+73>:	lea    esp,[ecx-0x4]
