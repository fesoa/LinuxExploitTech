# 03. Frame Faking (fake ebp)

* 함수가 호출될 때마다 새롭게 스택프레임이 만들어지고 반환될 때 ebp+4의 주소에서 ret를 불러오는 것을 이용한 기법
* leave / ret 인스트럭션에 대한 이해 필요



## leave / ret 이해하기

* 함수의 구성
  * 모든 함수는 프롤로그로 시작하여 에필로그로 종료됨
  * 이것이 필요한 이유는 함수의 데이터들을 넣을 스택프레임을 만들고, 반환하기 위해서임

```assembly
// 함수 프롤로그
   0x08049172 <+0>:	push   ebp
   0x08049173 <+1>:	mov    ebp,esp
   ...(중략)
// 함수 에필로그
   0x08049196 <+36>:	leave
   0x08049197 <+37>:	ret
```

* leave / ret 의 구성

```assembly
leave
	mov esp, ebp  # esp에 현재의 ebp를 넣음
	pop ebp		  # 스택 최상단(esp)에서 값을 뽑아 ebp로 넣음
ret
	pop eip		  # 스택 최상단(esp)에서 값을 뽑아 eip로 넣음
	jmp eip		  # eip로 점프
```

* 이해를 돕기 위해 도형화 하면

```
1. main에서 sum을 호출하는 상황
call sum
push ebp
mov	 ebp, esp
━━━━━━━━━━━━━━━━━━━━━━━━━━━(높은주소)
......
━━━━━━━━━━━━━━━━━━━━━━━━━━━
메인으로 돌아가야할 ret
━━━━━━━━━━━━━━━━━━━━━━━━━━━
이전 스택 프레임의 ebp						<---- esp
━━━━━━━━━━━━━━━━━━━━━━━━━━━



2. 이후 아래 스택에 sum에서 사용하는 데이터들이 사용될 것임

━━━━━━━━━━━━━━━━━━━━━━━━━━━(높은주소)
......
━━━━━━━━━━━━━━━━━━━━━━━━━━━
메인으로 돌아가야할 ret
━━━━━━━━━━━━━━━━━━━━━━━━━━━
이전 스택 프레임의 ebp					
━━━━━━━━━━━━━━━━━━━━━━━━━━━
....
━━━━━━━━━━━━━━━━━━━━━━━━━━━
....									<---- esp
━━━━━━━━━━━━━━━━━━━━━━━━━━━

3. Leave (mov esp, ebp)
ebp에는 현재 프레임의 최하단이 들어있으므로 이전 스택 프레임의 ebp가 저장되어 있는 곳으로 esp가 옮겨짐
━━━━━━━━━━━━━━━━━━━━━━━━━━━(높은주소)
......
━━━━━━━━━━━━━━━━━━━━━━━━━━━
메인으로 돌아가야할 ret
━━━━━━━━━━━━━━━━━━━━━━━━━━━
이전 스택 프레임의 ebp						<---- esp
━━━━━━━━━━━━━━━━━━━━━━━━━━━

4. Leave (pop ebp)
esp가 가리키는 값을 뽑아 ebp레지스터에 저장: 즉 ebp에 이전 스택 프레임의 ebp가 저장되고 esp는 내려가 ret를 가리키게 됨
━━━━━━━━━━━━━━━━━━━━━━━━━━━(높은주소)
......
━━━━━━━━━━━━━━━━━━━━━━━━━━━
메인으로 돌아가야할 ret						<---- esp
━━━━━━━━━━━━━━━━━━━━━━━━━━━

5. ret(pop eip)
esp가 가리키던 값, 즉 ret 값을 뽑아 eip 로 전달
━━━━━━━━━━━━━━━━━━━━━━━━━━━(높은주소)
......									<---- esp
━━━━━━━━━━━━━━━━━━━━━━━━━━━

6. ret(jmp eip)
eip가 가리키는 값으로 CPU 실행을 옮김
━━━━━━━━━━━━━━━━━━━━━━━━━━━(높은주소)
......									<---- esp
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```
