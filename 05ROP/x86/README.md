# 05. ROP #1

* x86



## 기본 RTL

```
    |---------------|
    |      			|
    |---------------|
    | 	  인자1	   |
    |---------------|
    |system종료후 ret |
    |---------------|
    |  system 주소   |
    |---------------|
    |               |
    |---------------|
    |               |
    |---------------|
```







## ROP

* 가젯이란?



* 왜 가젯이 필요한가?
  * 여러함수를 사용하게 될 때 필요함

```
    |---------------|
    |      			|
    |---------------|
    | 	  인자1	   |
    |---------------|
    |system종료후 ret |
    |---------------|
    |  system 주소   |
    |---------------|
    |   인자2        |
    |---------------|
    |   인자1        |
    |---------------|
    |  pop;pop;ret  |
    |---------------|
    |  함수A 주소     |
    |---------------|
    |               |
    |---------------|
```



### PoC

### 1) 기본정보 획득

```c
//gcc -m32 -fno-stack-protector -w -no-pie -mpreferred-stack-boundary=2 -o rop rop.c

#include<stdio.h>
#include<unistd.h>

void vuln(){
    char buf[50];
    read(0,buf,256);
}

void main(){
    write(1,"Let's ROP\n",10);
    vuln();
}
```



```bash
gdb-peda$ disass main
Dump of assembler code for function main:
   0x0804919e <+0>:	push   ebp
   0x0804919f <+1>:	mov    ebp,esp
   0x080491a1 <+3>:	push   ebx
   0x080491a2 <+4>:	call   0x80491cc <__x86.get_pc_thunk.ax>
   0x080491a7 <+9>:	add    eax,0x2e59
   0x080491ac <+14>:	push   0xa
   0x080491ae <+16>:	lea    edx,[eax-0x1ff8]
   0x080491b4 <+22>:	push   edx
   0x080491b5 <+23>:	push   0x1
   0x080491b7 <+25>:	mov    ebx,eax
   0x080491b9 <+27>:	call   0x8049050 <write@plt>
   0x080491be <+32>:	add    esp,0xc
   0x080491c1 <+35>:	call   0x8049172 <vuln>
   0x080491c6 <+40>:	nop
   0x080491c7 <+41>:	mov    ebx,DWORD PTR [ebp-0x4]
   0x080491ca <+44>:	leave
   0x080491cb <+45>:	ret
End of assembler dump.
gdb-peda$ disass vuln
Dump of assembler code for function vuln:
   0x08049172 <+0>:	push   ebp
   0x08049173 <+1>:	mov    ebp,esp
   0x08049175 <+3>:	push   ebx
   0x08049176 <+4>:	sub    esp,0x34
   0x08049179 <+7>:	call   0x80491cc <__x86.get_pc_thunk.ax>
   0x0804917e <+12>:	add    eax,0x2e82
   0x08049183 <+17>:	push   0x100
   0x08049188 <+22>:	lea    edx,[ebp-0x36]
   0x0804918b <+25>:	push   edx
   0x0804918c <+26>:	push   0x0
   0x0804918e <+28>:	mov    ebx,eax
   0x08049190 <+30>:	call   0x8049030 <read@plt>
   0x08049195 <+35>:	add    esp,0xc
   0x08049198 <+38>:	nop
   0x08049199 <+39>:	mov    ebx,DWORD PTR [ebp-0x4]
   0x0804919c <+42>:	leave
   0x0804919d <+43>:	ret
End of assembler dump.
gdb-peda$
```



* breakpoint
  * b *vuln
  * b *vuln+30 : read() 호출 직전

```
gdb-peda$ b *vuln
Breakpoint 1 at 0x8049172
gdb-peda$ b* vuln+30
Breakpoint 2 at 0x8049190
gdb-peda$
```



* b *vuln
  * vuln이 호출된 직후이므로 ret가 esp에 저장되어 있을 것임(프롤로그 시작전)
  * 즉 이 $esp가 덮어씌어야할 곳임

```bash
Breakpoint 1, 0x08049172 in vuln ()
gdb-peda$ i r $esp
esp            0xffffd600	0xffffd600
gdb-peda$ x/wx $esp
0xffffd600:	0x080491c6
gdb-peda$

   0x080491c1 <+35>:	call   0x8049172 <vuln>
   0x080491c6 <+40>:	nop
```

```
-----------------------  (높)주소
0x080491c6(돌아갈 ret)		<--- esp: 0xffffd600
━━━━━━━━━━━━━━━━
```



* b *vuln+30
  * vuln의 프롤로그 이후 buf가 설정되고, read 함수를 부르기 위해 read함수의 인자값 3개를 넣은 직후임
  * 두번째 인자값이 buf의 시작 주소

```bash
gdb-peda$ x/4wx $esp
0xffffd5b8:	0x00000000	0xffffd5c6	0x00000100	0xf7fa5000
gdb-peda$
```



* 오프셋 계산
  * vuln의 ret가 담긴 주소 - buf 시작주소

```
gdb-peda$ p/d 0xffffd600 - 0xffffd5c6
$2 = 58
gdb-peda$
```



### 2) ROP 체인

* 쓰기 가능 메모리 공간 확인
  * 0804c000-0804d000 rw-p 00003000 08:01 88  

```bash
gdb-peda$ shell ps -ef |grep 'rop'
root       3511   1884  0 01:13 pts/1    00:00:00 gdb ./rop
root       3515   3511  0 01:13 pts/1    00:00:00 /root/Study/LinuxExTech/05.ROP/rop
root       3580   3511  0 01:16 pts/1    00:00:00 bash -c ps -ef |grep 'rop'
root       3582   3580  0 01:16 pts/1    00:00:00 grep rop
gdb-peda$ cat /proc/3515/maps
08048000-08049000 r--p 00000000 08:01 88                                 /root/Study/LinuxExTech/05.ROP/rop
08049000-0804a000 r-xp 00001000 08:01 88                                 /root/Study/LinuxExTech/05.ROP/rop
0804a000-0804b000 r--p 00002000 08:01 88                                 /root/Study/LinuxExTech/05.ROP/rop
0804b000-0804c000 r--p 00002000 08:01 88                                 /root/Study/LinuxExTech/05.ROP/rop
0804c000-0804d000 rw-p 00003000 08:01 88                                 /root/Study/LinuxExTech/05.ROP/rop
f7dcb000-f7de4000 r--p 00000000 08:01 395446                             /usr/lib32/libc-2.28.so
f7de4000-f7f32000 r-xp 00019000 08:01 395446                             /usr/lib32/libc-2.28.so
f7f32000-f7fa2000 r--p 00167000 08:01 395446                             /usr/lib32/libc-2.28.so
f7fa2000-f7fa3000 ---p 001d7000 08:01 395446                             /usr/lib32/libc-2.28.so
f7fa3000-f7fa5000 r--p 001d7000 08:01 395446                             /usr/lib32/libc-2.28.so
f7fa5000-f7fa6000 rw-p 001d9000 08:01 395446                             /usr/lib32/libc-2.28.so
f7fa6000-f7fa9000 rw-p 00000000 00:00 0
f7fcd000-f7fcf000 rw-p 00000000 00:00 0
f7fcf000-f7fd2000 r--p 00000000 00:00 0                                  [vvar]
f7fd2000-f7fd4000 r-xp 00000000 00:00 0                                  [vdso]
f7fd4000-f7fd5000 r--p 00000000 08:01 395441                             /usr/lib32/ld-2.28.so
f7fd5000-f7ff1000 r-xp 00001000 08:01 395441                             /usr/lib32/ld-2.28.so
f7ff1000-f7ffb000 r--p 0001d000 08:01 395441                             /usr/lib32/ld-2.28.so
f7ffc000-f7ffd000 r--p 00027000 08:01 395441                             /usr/lib32/ld-2.28.so
f7ffd000-f7ffe000 rw-p 00028000 08:01 395441                             /usr/lib32/ld-2.28.so
fffdd000-ffffe000 rw-p 00000000 00:00 0                                  [stack]
gdb-peda$
```



* Section 확인

```
gdb-peda$ shell objdump -h /root/Study/LinuxExTech/05.ROP/rop

/root/Study/LinuxExTech/05.ROP/rop:     file format elf32-i386

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .interp       00000013  08048194  08048194  00000194  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  1 .note.ABI-tag 00000020  080481a8  080481a8  000001a8  2**2

 ...

 21 .got.plt      00000018  0804c000  0804c000  00003000  2**2
                  CONTENTS, ALLOC, LOAD, DATA
 22 .data         00000008  0804c018  0804c018  00003018  2**2
                  CONTENTS, ALLOC, LOAD, DATA
 23 .bss          00000004  0804c020  0804c020  00003020  2**0
```

| Section Name | memory address | size |
| ------------ | -------------- | ---- |
| .got.plt     | 0804c000       | 0x18 |
| .data        | 0804c018       | 0x8  |
| .bss         | 0804c020       | 0x4  |



* 가젯 찾기

```
gdb-peda$ ropgadget
ret = 0x804900a
popret = 0x804901e
pop2ret = 0x8049222
pop3ret = 0x8049221
pop4ret = 0x8049220
addesp_12 = 0x804901b
addesp_16 = 0x80490e2
gdb-peda$
```



* .plt, .got 주소 찾기

  * read

    ```
    gdb-peda$ elfsymbol read
    Detail symbol info
    read@reloc = 0
    read@plt = 0x8049030
    read@got = 0x804c00c
    ```

  * write

    ```
    gdb-peda$ elfsymbol write
    Detail symbol info
    write@reloc = 0x10
    write@plt = 0x8049050
    write@got = 0x804c014
    ```



* system 함수 주소 및 오프셋 찾기

```
gdb-peda$ p system
$1 = {<text variable, no debug info>} 0xf7e09980 <system>
gdb-peda$ p read
$2 = {<text variable, no debug info>} 0xf7eb2ff0 <read>
gdb-peda$ p/x 0xf7eb2ff0 - 0xf7e09980
$3 = 0xa9670
```
