# Memory구조 이해

*

## 개략적인 구조

```
---------------------(높은주소)
Kernel 영역
---------------------
스택영역(지역변수) : 아래로 자람
---------------------
힙영역(동적할당)
---------------------
데이터영역
---------------------
코드영역
----------------------(낮은주소)
```



## 스택이해

### 1) 스택 프레임의 생성과 삭제

* stack은 높은 주소에서 낮은 주소로 자람
* 관련 주요 레지스터
  * rbp(ebp): 스택의 베이스
  * rsp(esp): 스택의 최상단(아래로 자라므로 가장 낮은 주소가 됨)
  * eip(eip)
* 아래의 프로그램을 통해 함수가 호출될 때의 스택의 변화를 단계적으로 살펴보자.

```c
//stack.c
#include <stdio.h>

int sum(int a, int b){
    return a+b;
}
int main(){
    sum(1,2);
}

```

```bash
gdb-peda$ disass main
Dump of assembler code for function main:
   0x08049169 <+0>:     push   ebp
   0x0804916a <+1>:     mov    ebp,esp
   0x0804916c <+3>:     call   0x8049189 <__x86.get_pc_thunk.ax>
   0x08049171 <+8>:     add    eax,0x2e8f
   0x08049176 <+13>:    push   0x2
   0x08049178 <+15>:    push   0x1
   0x0804917a <+17>:    call   0x8049152 <sum>
   0x0804917f <+22>:    add    esp,0x8
   0x08049182 <+25>:    mov    eax,0x0
   0x08049187 <+30>:    leave
   0x08049188 <+31>:    ret
End of assembler dump.
gdb-peda$ disass sum
Dump of assembler code for function sum:
   0x08049152 <+0>:     push   ebp
   0x08049153 <+1>:     mov    ebp,esp
   0x08049155 <+3>:     call   0x8049189 <__x86.get_pc_thunk.ax>
   0x0804915a <+8>:     add    eax,0x2ea6
   0x0804915f <+13>:    mov    edx,DWORD PTR [ebp+0x8]
   0x08049162 <+16>:    mov    eax,DWORD PTR [ebp+0xc]
   0x08049165 <+19>:    add    eax,edx
   0x08049167 <+21>:    pop    ebp
   0x08049168 <+22>:    ret
End of assembler dump.
gdb-peda$
```

* 아래와 같이 breakpoint를 잡아 각 부분별 스택 상황을 살펴봄
  * main+0: push ebp 전
  * main+1: push ebp후,  mov ebp, esp 전
  * main+3: mov ebp, esp 후
  * main+17: call sum 전
  * sum+0: call sum 후, push ebp 전
  * sum+1: push ebp후, mov ebp, esp 전
  * sum+3: mov ebp, esp 후
  * sum+22: ret 전
  * main+22: sum ret 후

```
gdb-peda$ b *main+0
Breakpoint 1 at 0x8049169
gdb-peda$ b *main+1
Breakpoint 2 at 0x804916a
gdb-peda$ b *main+3
Breakpoint 3 at 0x804916c
gdb-peda$ b *main+17
Breakpoint 4 at 0x804917a
gdb-peda$ b *sum+0
Breakpoint 5 at 0x8049152
gdb-peda$ b *sum+1
Breakpoint 6 at 0x8049153
gdb-peda$ b *sum+3
Breakpoint 7 at 0x8049155
gdb-peda$ b *sum+22
Breakpoint 8 at 0x8049168
gdb-peda$ b *main+22
Breakpoint 9 at 0x804917f
gdb-peda$ r

```

* main+0: push ebp 전

```
[Stack]
0000| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0004| 0xffffd600 --> 0x1
...
[register]
EBP: 0x0
ESP: 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:        add    esp,0x10)

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		esp:0xffffd5fc
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

* main+1: push ebp 후

```
[Stack]
0000| 0xffffd5f8 --> 0x0
0004| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0008| 0xffffd600 --> 0x1
...
[register]
EBP: 0x0
ESP: 0xffffd5f8 --> 0x0

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  esp:0xffffd5f8
-------------------------

```

* main+3: mov ebp, esp 후
  * 여기서 새로운 스택 프레임(main)이 만들어짐

```
[Stack]
0000| 0xffffd5f8 --> 0x0
0004| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0008| 0xffffd600 --> 0x1
...
[register]
EBP: 0xffffd5f8 --> 0x0 <-- 변경됨
ESP: 0xffffd5f8 --> 0x0

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  esp:0xffffd5f8
-------------------------

```

* main+17
  * sum 함수의 인자가 오른쪽부터 삽입됨

```
[Stack]
0000| 0xffffd5f0 --> 0x1
0004| 0xffffd5f4 --> 0x2
0008| 0xffffd5f8 --> 0x0
0012| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0016| 0xffffd600 --> 0x1

...
[register]
EBP: 0xffffd5f8 --> 0x0
ESP: 0xffffd5f0 --> 0x1

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		    esp:0xffffd5f0
-------------------------
```

* sum+0: sum 함수의 push ebp 전

```
[Stack]
0000| 0xffffd5ec --> 0x804917f (<main+22>:      add    esp,0x8)
0004| 0xffffd5f0 --> 0x1
0008| 0xffffd5f4 --> 0x2
0012| 0xffffd5f8 --> 0x0
0016| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0020| 0xffffd600 --> 0x1
...
[register]
EBP: 0xffffd5f8 --> 0x0
ESP: 0xffffd5ec --> 0x804917f (<main+22>:       add    esp,0x8)

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		   
-------------------------
0x804917f(sum이후 리턴할 곳)	esp:0xffffd5ec
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

* sum+1: push ebp 후

```
[Stack]
0000| 0xffffd5e8 --> 0xffffd5f8 --> 0x0
0004| 0xffffd5ec --> 0x804917f (<main+22>:      add    esp,0x8)
0008| 0xffffd5f0 --> 0x1
0012| 0xffffd5f4 --> 0x2
0016| 0xffffd5f8 --> 0x0
0020| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0024| 0xffffd600 --> 0x1
...
[register]
EBP: 0xffffd5f8 --> 0x0
ESP: 0xffffd5e8 --> 0xffffd5f8 --> 0x0

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		   
-------------------------
0x804917f(sum이후 리턴할 곳)
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0xffffd5f8(main의 ebp)	  esp: 0xffffd5e8
-------------------------
```

* sum+3: mov ebp, esp 후
  * sum의 스택프레임이 새로 생성됨

```
[Stack]
0000| 0xffffd5e8 --> 0xffffd5f8 --> 0x0
0004| 0xffffd5ec --> 0x804917f (<main+22>:      add    esp,0x8)
0008| 0xffffd5f0 --> 0x1
0012| 0xffffd5f4 --> 0x2
0016| 0xffffd5f8 --> 0x0
0020| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0024| 0xffffd600 --> 0x1
...
[register]
EBP: 0xffffd5e8 --> 0xffffd5f8 --> 0x0  <-- 변경됨
ESP: 0xffffd5e8 --> 0xffffd5f8 --> 0x0


[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		   
-------------------------
0x804917f(sum이후 리턴할 곳)
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0xffffd5f8(main의 ebp)	  esp: 0xffffd5e8
-------------------------
```

* sum+22: ret 전
  * sum+21에서 pop ebp를 통해 스택의 값을 ebp로 넣음
  * esp가 가리키는 값에 ret 주소가 들어있음

```
[Stack]
0000| 0xffffd5ec --> 0x804917f (<main+22>:      add    esp,0x8)
0004| 0xffffd5f0 --> 0x1
0008| 0xffffd5f4 --> 0x2
0012| 0xffffd5f8 --> 0x0
0016| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0020| 0xffffd600 --> 0x1

[register]
EBP: 0xffffd5f8 --> 0x0   <-- 메인의 스택프레임 주소로 변경
ESP: 0xffffd5ec --> 0x804917f (<main+22>:       add    esp,0x8)

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		   
-------------------------
0x804917f(sum이후 리턴할 곳)	esp: 0xffffd5ec
━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

* main+22: sum 함수 종료

```
[Stack]
0000| 0xffffd5f0 --> 0x1
0004| 0xffffd5f4 --> 0x2
0008| 0xffffd5f8 --> 0x0
0012| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0016| 0xffffd600 --> 0x1

[register]
EBP: 0xffffd5f8 --> 0x0
ESP: 0xffffd5f0 --> 0x1

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						  
-------------------------
2(sum함수의 인자)
-------------------------
1(sum함수의 인자)		  esp: 0xffffd5f0
-------------------------
```

* main+25
  * add esp, 0x8 ; esp에 0x8을 더하므로 esp가 상단으로 올라감

```
[Stack]
0000| 0xffffd5f8 --> 0x0
0004| 0xffffd5fc --> 0xf7de5b41 (<__libc_start_main+241>:       add    esp,0x10)
0008| 0xffffd600 --> 0x1


[register]
EBP: 0xffffd5f8 --> 0x0
ESP: 0xffffd5f8 --> 0x0

[Stack 모양]
------------------------  (높)주소
0xf7de5b41(돌아갈 ret)		
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0						 esp: 0xffffd5f8
-------------------------
```
