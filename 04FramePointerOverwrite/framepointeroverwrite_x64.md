# 04. Frame Pointer Overwrite(x86)

* 32비트에는 stack Aligment가 적용됨
* 64비트 공격 요약
  * rbp의 1바이트를 조작하여 이 값이 원하는ret - 8를 가리키게 함
  * payload: null padding(8바이트) + pop rdi;ret 가젯 + /bin/sh 주소 + system 주소 + "\x90"패딩 + 1바이트오버플로우

* 32비트라면 1바이트를 조작하여 원하는 ret - 4를 가리키게 해야하지만 stack aligment로 인해 안됨



## 정상적인 stack aligment

* main 함수 프롤로그에서 아래와 같은 상황이 이루어진다.
  * 초기에 저장된 $ecx의 값은 종료때까지 변화하지 않음

```
			|-----------------------|
			|    	        		| <---$ecx에 담긴 값이 가리키는 주소
      	  	|-----------------------|
			| 		   Ret			| <===$ecx-4
      	  	|-----------------------|
			|          0x0        	|
      	  	|-----------------------|
			|       0xf7f9f000   	|
      	  	|-----------------------|
			|       0xf7f9f000     	|
      	  	|-----------------------|
			| 		   Ret			| <===$ecx-4에 담긴 값 저장
      	  	|-----------------------|
			|     	   0x0			|<---$esp, $ebp
      	  	|-----------------------|
```

* main에서 호출한 함수가 종료될 때 저장되어 있던 main프레임의 ebp 값이 $ebp 레지스터에 저장됨

------

* 함수 에필로그에서는 아래와 같은 상황이 이루어진다.

```
			|-----------------------|
			|    	        		| <---$ecx에 담긴 값이 가리키는 주소
      	  	|-----------------------|
			| 		   Ret			| <===$ecx-4
      	  	|-----------------------|
			|          0x0        	|
      	  	|-----------------------|
			|       0xf7f9f000   	|
      	  	|-----------------------|
			|       0xf7f9f000     	|
      	  	|-----------------------|
			|  		정렬후 Ret		   | <===$ecx-4에 담긴 값 저장
      	  	|-----------------------|
			|     	   0x0			| <---$ebp
      	  	|-----------------------|
			|     	   0x0			|
      	  	|-----------------------|
			|      	 $ecx 주소	   | <---$esp
      	  	|-----------------------|
```

* "mov ecx,DWORD PTR [ebp-0x4]" 코드나 	lea    esp,[ebp-0x8]; pop    ecx 코드로 ecx에 ebp-0x4에 저장된 값이 저장됨

```
			|-----------------------|
			|    	        		| <---$ecx에 담긴 값이 가리키는 주소
      	  	|-----------------------|
			| 		   Ret			| <===$ecx-4
      	  	|-----------------------|
			|          0x0        	|
      	  	|-----------------------|
			|       0xf7f9f000   	|
      	  	|-----------------------|
			|       0xf7f9f000     	|
      	  	|-----------------------|
			|  		정렬후 Ret		   | <===$ecx-4에 담긴 값 저장
      	  	|-----------------------|
			|     	   0x0			| <---$ebp
      	  	|-----------------------|
			|     	   0x0			| <---$esp
      	  	|-----------------------|
			|      	 $ecx 주소	   | ===> 이값이 ecx에 들어감
      	  	|-----------------------|
```

*  pop    ebx / pop    ebp

```
			|-----------------------|
			|    	        		| <---$ecx에 담긴 값이 가리키는 주소
      	  	|-----------------------|
			| 		   Ret			| <===$ecx-4
      	  	|-----------------------|
			|          0x0        	|
      	  	|-----------------------|
			|       0xf7f9f000   	|
      	  	|-----------------------|
			|       0xf7f9f000     	|
      	  	|-----------------------|
			|  		정렬후 Ret		   | <---$esp
      	  	|-----------------------|
			|     	   0x0			| ===>$ebp
      	  	|-----------------------|
			|     	   0x0			| ===>$ebx
      	  	|-----------------------|
			|      	 $ecx 주소	   | ===>$ecx
      	  	|-----------------------|
```

* lea    esp,[ecx-0x4]

```
			|-----------------------|
			|    	        		| <---$ecx에 담긴 값이 가리키는 주소
      	  	|-----------------------|
			| 		   Ret			| <---$esp
      	  	|-----------------------|
```



## ebp의 1바이트가 조작되었을시

- 정상적이라면 함수 에필로그에서는 아래와 같은 상황이 이루어진다.

  ```
  			|-----------------------|
  			|    	        		| <---$ecx에 담긴 값이 가리키는 주소
        	  	|-----------------------|
  			| 		   Ret			| <===$ecx-4
        	  	|-----------------------|
  			|          0x0        	|
        	  	|-----------------------|
  			|       0xf7f9f000   	|
        	  	|-----------------------|
  			|       0xf7f9f000     	|
        	  	|-----------------------|
  			|  		정렬후 Ret		   | <===$ecx-4에 담긴 값 저장
        	  	|-----------------------|
  			|     	   0x0			| <---$ebp
        	  	|-----------------------|
  			|     	   0x0			|
        	  	|-----------------------|
  			|      	 $ecx 주소	   | <---$esp
        	  	|-----------------------|
  ```

  이 다음으로 조작된 ebp - 4가  ecx에 저장됨

  ```
  			|-----------------------|
  			|    	        		| <---$ecx에 담긴 값이 가리키는 주소
        	  	|-----------------------|
  			| 		   Ret			| <===$ecx-4
        	  	|-----------------------|
  			|          0x0        	|
        	  	|-----------------------|
  			|       0xf7f9f000   	|
        	  	|-----------------------|
  			|       0xf7f9f000     	|
        	  	|-----------------------|
  			|  		정렬후 Ret		   | <===$ecx-4에 담긴 값 저장
        	  	|-----------------------|
  			|     	   0x0			| <---$ebp
        	  	|-----------------------|
  			|     	   0x0			| <---$esp
        	  	|-----------------------|
  			|      	 $ecx 주소	   | ===> 이값이 ecx에 들어감
        	  	|-----------------------|
  ```

  - 그리고 esp를 ecx-4로 바꿈
  - 여기에는 ret가 담겨있음

- 정리하면 조작된 ebp -4 가 ecx가 되고 ecx-4에 있는 값이 ret이므로 조작된 ebp - 8에 있는 값이 ret 값이 됨
